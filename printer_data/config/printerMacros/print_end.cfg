####################################################################################################
######################################### PRINT ENDING #############################################
####################################################################################################

####################################################################################################
################################### MAIN END PRINT SEQUENCE ########################################
####################################################################################################

[gcode_macro END_PRINT]
description: Execute complete print ending sequence
gcode:
    {% set macrocfg = printer['gcode_macro _macroVariables'] %}
    
    # Calculate clean variables first
    {% set end_raise_distance = macrocfg.end_raise %}
    {% set z_lift_speed = macrocfg.end_z_lift_speed %}

    G91
    G1 Z{end_raise_distance} F{z_lift_speed}                    # Immediately raises toolhead to prevent melting 
    G90
        
    {% if macrocfg.end_print == True %}
        # Final movement completion
        M400                                                    # Wait for all moves to finish

        # Filament handling based on configuration
        {% if macrocfg.end_unload == True %}
            UNLOAD_FILAMENT                                     # Complete filament unload
        {% else %}
            {% set retract_speed = macrocfg.end_retract_speed %}
            G1 E-{macrocfg.end_retract_length} F{retract_speed}  # Standard retraction
        {% endif %}

        # LED status indication for completion
        _SET_LED_STATUS STATUS=finished
        
        # Optional nozzle cleaning
        {% if macrocfg.clean_end == True %}
            {macrocfg.clean_macro}                              # Execute nozzle cleaning
        {% endif %}
        
        # Park toolhead at configured position
        {macrocfg.park_base}                                    # Execute parking sequence
        
        # Success notification and audio feedback
        RESPOND MSG="üèÅ Print complete"
        {% if macrocfg.audio_status == True %}
            {macrocfg.success_audio}                            # Play success audio
        {% endif %}
        
        # Begin component shutdown sequence
        _STOP_COMPONENTS
    {% endif %}


####################################################################################################
################################## COMPONENT SHUTDOWN CONTROL ######################################
####################################################################################################

[gcode_macro _STOP_COMPONENTS]
description: Comprehensive component shutdown after print completion
gcode:
    {% set macrocfg = printer['gcode_macro _macroVariables'] %}
    
    # Disable filament sensors if auto-management enabled
    {% if macrocfg.auto_filament_sensor == True %}
        _DISABLE_FILAMENT_SENSOR                                # Disable filament sensors
    {% endif %}
    
    # Controller fan management
    {% if macrocfg.controller_fan == True %}
        {macrocfg.controller_fan_stop}                          # Stop controller fan
    {% endif %}

    # Reset printer settings to defaults
    _SET_DEFAULTS MODE=END                                      # Apply end-print defaults
    
    # Air management system activation
    {% if macrocfg.use_scrubber == True %}
        _SCRUBBER                                               # Start VOC scrubbing cycle
    {% else %}
        {% if macrocfg.exhaust_fan == True %}
            RESPOND MSG="Exhausting chamber"
            {macrocfg.exhaust_fan_start}                        # Start exhaust fan
            UPDATE_DELAYED_GCODE ID=_EXHAUST_FAN_DELAY DURATION={macrocfg.exhaust_time}
        {% else %}
            # Direct power-off if no air management needed
            {% if macrocfg.power_off == True %}
                {macrocfg.off_macro}                            # Execute power off sequence
            {% endif %}
        {% endif %}
    {% endif %}
    
    # Final hardware shutdown
    G90                                                         # Ensure absolute coordinates
    TURN_OFF_HEATERS                                            # Turn off all heaters
    M84                                                         # Disable stepper motors


####################################################################################################
################################### EXHAUST FAN DELAY CONTROL ######################################
####################################################################################################

[delayed_gcode _EXHAUST_FAN_DELAY]
gcode:
    {% set macrocfg = printer['gcode_macro _macroVariables'] %}
    
    RESPOND MSG="‚úÖ Exhaust cycle complete"
    {macrocfg.exhaust_fan_stop}                                 # Stop exhaust fan
    
    # Execute final shutdown sequence if end print is active
    {% if macrocfg.end_print == True %}
        _SET_DEFAULTS MODE=END                                  # Apply end-print defaults
        {% if macrocfg.power_off == True %}
            {macrocfg.off_macro}                                # Execute power off sequence
        {% endif %}
    {% endif %}
    