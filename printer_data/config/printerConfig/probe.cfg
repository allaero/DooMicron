####################################################################################################
#################################### MOVEMENT CALIBRATION ##########################################
####################################################################################################

####################################################################################################
################################## INPUT SHAPING MEASUREMENT #######################################
####################################################################################################

[adxl345]                                                      # ADXL345 accelerometer for vibration measurement and input shaping
cs_pin: EBBCan: ADXL_CS                                        # SPI chip select pin
spi_software_sclk_pin: EBBCan: ADXL_SCLK                       # SPI software clock pin
spi_software_mosi_pin: EBBCan: ADXL_MOSI                       # SPI software MOSI pin
spi_software_miso_pin: EBBCan: ADXL_MISO                       # SPI software MISO pin
axes_map: x,y,z                                                # Accelerometer axis mapping

[resonance_tester]                                             # Resonance testing configuration for input shaper calibration
accel_chip: adxl345                                            # Accelerometer chip to use for testing
probe_points: 90,90,20                                         # Test point coordinates (X,Y,Z)

[input_shaper]                                                 # Input shaper configuration to reduce ringing artifacts
shaper_freq_x: 61.6                                            # X-axis shaper frequency (Hz)
shaper_type_x: mzv                                             # X-axis shaper type (MZV algorithm)
shaper_freq_y: 77.8                                            # Y-axis shaper frequency (Hz)
shaper_type_y: ei                                              # Y-axis shaper type (EI algorithm)
damping_ratio_x: 0.092                                         # X-axis damping ratio
damping_ratio_y: 0.113                                         # Y-axis damping ratio

[shaketune]                                                    # Advanced input shaper tuning and analysis tool
result_folder: ~/printer_data/config/inputShaper               # Directory for storing test results
number_of_results_to_keep: 10                                  # Maximum number of result files to retain
keep_raw_data: False                                           # Delete raw measurement data after processing
show_macros_in_webui: False                                    # Hide shaketune macros from web interface
timeout: 600                                                   # Test timeout duration (seconds)
measurements_chunk_size: 2                                     # Number of measurements per processing chunk
max_freq: 200                                                  # Maximum frequency for testing (Hz)
dpi: 300                                                       # Chart resolution (dots per inch)


####################################################################################################
######################################### PROBE SYSTEM #############################################
####################################################################################################

[probe]                                                        # Inductive probe for bed leveling and mesh generation
pin: ^EBBCan:MADMAX                                            # Probe signal pin (pullup enabled)
x_offset: 0                                                    # Probe X offset from nozzle tip
y_offset: 0                                                    # Probe Y offset from nozzle tip
speed: 4.0                                                     # Probe movement speed (mm/s)
samples: 3                                                     # Number of probe samples per point
samples_result: median                                         # Use median of multiple samples
sample_retract_dist: 3                                         # Distance to retract between samples
samples_tolerance: 0.060                                       # Maximum deviation between samples
samples_tolerance_retries: 5                                   # Number of retry attempts for tolerance

activate_gcode:
    {% set PROBE_TEMP = 150 %}
    {% set MAX_TEMP = PROBE_TEMP + 5 %}
    {% set ACTUAL_TEMP = printer.extruder.temperature %}
    {% set TARGET_TEMP = printer.extruder.target %}
    
    {% if TARGET_TEMP > PROBE_TEMP %}
        { action_respond_info('Extruder target: %.1fC is too high, lowering to %.1fC' % (TARGET_TEMP, PROBE_TEMP)) }
        M106 S255
        M109 S{ PROBE_TEMP }
    {% else %}
        # Temperature target is already low enough, but nozzle may still be too hot.
        {% if ACTUAL_TEMP > MAX_TEMP %}
            { action_respond_info('Extruder temp: %.1fC is too high, cooling to: %.1fC' % (ACTUAL_TEMP, MAX_TEMP)) }
            M106 S255
            TEMPERATURE_WAIT SENSOR=extruder MAXIMUM={ MAX_TEMP }
        {% endif %}
    {% endif %}
    M106 S0


####################################################################################################
################################### QUAD GANTRY LEVELING ###########################################
####################################################################################################

[quad_gantry_level]                                            # Quad gantry leveling for automatic Z-axis tramming
gantry_corners:                                                # Physical gantry corner positions
   -60.5, -8.9                                                 # Front left gantry corner coordinate
   234.5, 244.1                                                # Rear right gantry corner coordinate
points:                                                        # Probe points for gantry leveling
   25,25                                                       # Front left probe point
   25,155                                                      # Rear left probe point
   155,155                                                     # Rear right probe point
   155,25                                                      # Front right probe point
speed: 300                                                     # Movement speed during leveling (mm/s)
horizontal_move_z: 2                                           # Z height for horizontal movements
retries: 5                                                     # Maximum number of leveling attempts
retry_tolerance: 0.060                                         # Tolerance for successful leveling (mm)
max_adjust: 10                                                 # Maximum adjustment distance per motor (mm)


####################################################################################################
##################################### BED MESH LEVELING ############################################
####################################################################################################

[bed_mesh]                                                     # Bed mesh configuration for surface height mapping
speed: 300                                                     # Probe movement speed (mm/s)
horizontal_move_z: 3                                           # Z height for horizontal movements
mesh_min: 20, 20                                               # Minimum X,Y coordinates for mesh
mesh_max: 150,170                                              # Maximum X,Y coordinates for mesh
zero_reference_position: 90,90                                 # Reference point for mesh zero (center)
fade_start: 0.6
