####################################################################################################
########################################## MCU CONFIGURATION #######################################
####################################################################################################

[mcu]                                                          # Main controller board - Manta M8P V2.0 with CB1
canbus_uuid: 96c64da30dd3                                       # Unique CAN bus identifier for main board
canbus_interface: can0                                         # CAN bus interface name for communication

[mcu EBBCan]                                                   # Toolhead controller board - EBB36 V1.2
canbus_uuid: 78dbfae6d51c                                      # Unique CAN bus identifier for toolhead board


####################################################################################################
######################################### PRINTER KINEMATICS #######################################
####################################################################################################

[printer]                                                      # Core XY printer motion configuration and limits
kinematics: corexy                                             # CoreXY kinematics for independent XY motors
max_velocity: 1000                                             # Maximum toolhead velocity (mm/s)
max_accel: 8000                                                # Maximum acceleration (mm/s²)
max_z_velocity: 125                                            # Maximum Z-axis velocity (mm/s)
max_z_accel: 250                                               # Maximum Z-axis acceleration (mm/s²)
square_corner_velocity: 10.0                                   # Maximum velocity for 90° corners (mm/s)

[idle_timeout]                                                 # Printer idle timeout configuration
timeout: 3000                                                  # Idle timeout duration (50 minutes)


####################################################################################################
############################################ BED HEATER ############################################
####################################################################################################

[heater_bed]                                                   # Main bed heater configuration for heated bed control
heater_pin: BED_HEATER                                         # SSR control pin for bed heater power
sensor_pin: BED_TEMP                                           # Thermistor input pin for bed temperature reading
sensor_type: Generic 3950                                      # Thermistor type (standard NTC 100K)
max_power: 0.8                                                 # Maximum power output (80% for safety/longevity)
min_temp: 0                                                    # Minimum safe bed temperature
max_temp: 120                                                  # Maximum safe bed temperature (safety limit)


####################################################################################################
######################################### PROBE SYSTEM #############################################
####################################################################################################

[probe]                                                        # Inductive probe for bed leveling and mesh generation
pin: ^EBBCan:MADMAX                                            # Probe signal pin (pullup enabled)
x_offset: 0                                                    # Probe X offset from nozzle tip
y_offset: 0                                                    # Probe Y offset from nozzle tip
speed: 4.0                                                     # Probe movement speed (mm/s)
samples: 3                                                     # Number of probe samples per point
samples_result: median                                         # Use median of multiple samples
sample_retract_dist: 3                                         # Distance to retract between samples
samples_tolerance: 0.060                                       # Maximum deviation between samples
samples_tolerance_retries: 5                                   # Number of retry attempts for tolerance

activate_gcode:
    {% set PROBE_TEMP = 150 %}
    {% set MAX_TEMP = PROBE_TEMP + 5 %}
    {% set ACTUAL_TEMP = printer.extruder.temperature %}
    {% set TARGET_TEMP = printer.extruder.target %}
    
    {% if TARGET_TEMP > PROBE_TEMP %}
        { action_respond_info('Extruder target: %.1fC is too high, lowering to %.1fC' % (TARGET_TEMP, PROBE_TEMP)) }
        M106 S255
        M109 S{ PROBE_TEMP }
    {% else %}
        # Temperature target is already low enough, but nozzle may still be too hot.
        {% if ACTUAL_TEMP > MAX_TEMP %}
            { action_respond_info('Extruder temp: %.1fC is too high, cooling to: %.1fC' % (ACTUAL_TEMP, MAX_TEMP)) }
            M106 S255
            TEMPERATURE_WAIT SENSOR=extruder MAXIMUM={ MAX_TEMP }
        {% endif %}
    {% endif %}
    M106 S0


####################################################################################################
################################### QUAD GANTRY LEVELING ###########################################
####################################################################################################

[quad_gantry_level]                                            # Quad gantry leveling for automatic Z-axis tramming
gantry_corners:                                                # Physical gantry corner positions
   -60.5, -8.9                                                 # Front left gantry corner coordinate
   234.5, 244.1                                                # Rear right gantry corner coordinate
points:                                                        # Probe points for gantry leveling
   25,25                                                       # Front left probe point
   25,155                                                      # Rear left probe point
   155,155                                                     # Rear right probe point
   155,25                                                      # Front right probe point
speed: 300                                                     # Movement speed during leveling (mm/s)
horizontal_move_z: 2                                           # Z height for horizontal movements
retries: 5                                                     # Maximum number of leveling attempts
retry_tolerance: 0.060                                         # Tolerance for successful leveling (mm)
max_adjust: 10                                                 # Maximum adjustment distance per motor (mm)


####################################################################################################
##################################### BED MESH LEVELING ############################################
####################################################################################################

[bed_mesh]                                                     # Bed mesh configuration for surface height mapping
speed: 300                                                     # Probe movement speed (mm/s)
horizontal_move_z: 3                                           # Z height for horizontal movements
mesh_min: 20, 20                                               # Minimum X,Y coordinates for mesh
mesh_max: 150,170                                              # Maximum X,Y coordinates for mesh
zero_reference_position: 90,90                                 # Reference point for mesh zero (center)
fade_start: 0.6
